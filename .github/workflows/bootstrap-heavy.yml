name: bootstrap-heavy

on:
  workflow_dispatch:
    inputs:
      run_determinism:
        description: Run compiler_main deterministic emit check
        required: false
        default: true
        type: boolean
      run_deep:
        description: Enable deep chain (stage4 -> stage5) in bootstrap_v0_13
        required: false
        default: false
        type: boolean
      run_compiler_smoke:
        description: Enable stage1/compiler module smoke in gate1
        required: false
        default: false
        type: boolean
      run_compiler_main_smoke:
        description: Enable compiler_main two-hop smoke in gate1
        required: false
        default: false
        type: boolean
      run_import_smoke:
        description: Enable import namespace smoke (import "x" as Foo; Foo::bar)
        required: false
        default: false
        type: boolean
      run_selfhost_eq:
        description: Compare stage3/stage4 compiler_main IR for convergence
        required: false
        default: false
        type: boolean
      reuse_stage3:
        description: Reuse dist/kooixc-stage3 when already present
        required: false
        default: true
        type: boolean
      reuse_stage2:
        description: Reuse dist/kooixc-stage2 when stage3 rebuild is needed
        required: false
        default: true
        type: boolean
      reuse_only:
        description: Fail fast when requested reuse artifacts are missing
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "37 3 * * *"

jobs:
  stage1-real-workload-smokes:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM tools (llc) + clang
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm clang

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Resolve bootstrap-heavy toggles
        id: toggles
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "determinism=${{ inputs.run_determinism }}" >> "$GITHUB_OUTPUT"
            echo "deep=${{ inputs.run_deep }}" >> "$GITHUB_OUTPUT"
            echo "compiler_smoke=${{ inputs.run_compiler_smoke }}" >> "$GITHUB_OUTPUT"
            echo "compiler_main_smoke=${{ inputs.run_compiler_main_smoke }}" >> "$GITHUB_OUTPUT"
            echo "import_smoke=${{ inputs.run_import_smoke }}" >> "$GITHUB_OUTPUT"
            echo "selfhost_eq=${{ inputs.run_selfhost_eq }}" >> "$GITHUB_OUTPUT"
            echo "reuse_stage3=${{ inputs.reuse_stage3 }}" >> "$GITHUB_OUTPUT"
            echo "reuse_stage2=${{ inputs.reuse_stage2 }}" >> "$GITHUB_OUTPUT"
            echo "reuse_only=${{ inputs.reuse_only }}" >> "$GITHUB_OUTPUT"
          else
            echo "determinism=true" >> "$GITHUB_OUTPUT"
            echo "deep=false" >> "$GITHUB_OUTPUT"
            echo "compiler_smoke=false" >> "$GITHUB_OUTPUT"
            echo "compiler_main_smoke=true" >> "$GITHUB_OUTPUT"
            echo "import_smoke=false" >> "$GITHUB_OUTPUT"
            echo "selfhost_eq=false" >> "$GITHUB_OUTPUT"
            echo "reuse_stage3=true" >> "$GITHUB_OUTPUT"
            echo "reuse_stage2=true" >> "$GITHUB_OUTPUT"
            echo "reuse_only=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run bootstrap-heavy gate script
        env:
          CARGO_BUILD_JOBS: "1"
          KX_HEAVY_DETERMINISM: ${{ steps.toggles.outputs.determinism }}
          KX_HEAVY_DEEP: ${{ steps.toggles.outputs.deep }}
          KX_HEAVY_S1_COMPILER: ${{ steps.toggles.outputs.compiler_smoke }}
          KX_HEAVY_COMPILER_MAIN_SMOKE: ${{ steps.toggles.outputs.compiler_main_smoke }}
          KX_HEAVY_IMPORT_SMOKE: ${{ steps.toggles.outputs.import_smoke }}
          KX_HEAVY_SELFHOST_EQ: ${{ steps.toggles.outputs.selfhost_eq }}
          KX_HEAVY_REUSE_STAGE3: ${{ steps.toggles.outputs.reuse_stage3 }}
          KX_HEAVY_REUSE_STAGE2: ${{ steps.toggles.outputs.reuse_stage2 }}
          KX_HEAVY_REUSE_ONLY: ${{ steps.toggles.outputs.reuse_only }}
          KX_HEAVY_MODULE_PREFLIGHT: "1"
          KX_HEAVY_MODULE_PREFLIGHT_ENTRY: "examples/import_variant_main.kooix"
          KX_HEAVY_SAFE_MODE: "1"
          KX_HEAVY_TIMEOUT_BOOTSTRAP: "900"
          KX_HEAVY_TIMEOUT: "900"
          KX_HEAVY_TIMEOUT_SMOKE: "300"
          KX_HEAVY_SAFE_MAX_VMEM_KB: "0"
        run: ./scripts/bootstrap_heavy_gate.sh

      - name: Validate module preflight json metrics
        if: success()
        run: ./scripts/bootstrap_module_preflight_json_check.sh /tmp/bootstrap-heavy-metrics.txt --assert

      - name: Upload bootstrap-heavy artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-heavy-artifacts
          path: |
            dist/kooixc1
            dist/kooixc-stage2
            dist/kooixc-stage4
            /tmp/kx-stage3-compiler-main.ll
            /tmp/kx-stage4-stage2-min.ll
            /tmp/kx-det-a.ll
            /tmp/kx-det-b.ll
            /tmp/kx-selfhost-eq.ll
            dist/kooixc-stage3-examples-import-main
            dist/kooixc-stage3-examples-import-alias-main
            dist/kooixc-stage3-examples-import-variant-main
            dist/kooixc-stage3-stage2-import-alias
            dist/kooixc-stage3-stage2-import-variant
            dist/kooixc-stage3-stage1-compiler-main-smoke
            dist/kooixc-stage4-stage2-min-smoke
            /tmp/kooixc_stage3_examples_import_main.ll
            /tmp/kooixc_stage3_examples_import_alias_main.ll
            /tmp/kooixc_stage3_examples_import_variant_main.ll
            /tmp/kooixc_stage3_stage2_import_alias.ll
            /tmp/kooixc_stage3_stage2_import_variant.ll
            /tmp/kooixc_stage3_stage1_compiler_main_smoke.ll
            /tmp/kooixc_stage4_stage2_min_smoke.ll
            dist/kooixc-stage3-stage2-s1-compiler-module-smoke
            /tmp/kooixc_stage3_stage2_s1_compiler_module_smoke.ll
            /tmp/bootstrap-heavy-bootstrap.log
            /tmp/bootstrap-heavy-resource.log
            /tmp/bootstrap-heavy-metrics.txt
            /tmp/kx-module-preflight-*.json
            /tmp/bootstrap-heavy-determinism.sha256
            /tmp/bootstrap-heavy-selfhost.sha256
            /tmp/kooixc_stage4_stage1_compiler.ll
            /tmp/kooixc_stage5_stage1_compiler.ll
          if-no-files-found: warn

      - name: Bootstrap-heavy summary
        if: always()
        run: |
          metrics_file=/tmp/bootstrap-heavy-metrics.txt
          det_file=/tmp/bootstrap-heavy-determinism.sha256
          selfhost_file=/tmp/bootstrap-heavy-selfhost.sha256
          gate1_resource_file=/tmp/bootstrap-heavy-resource.log
          fallback_gate1_resource_file=/tmp/kx-bootstrap-resource.log

          gate1="n/a"
          gate2="n/a"
          gate3="n/a"
          total="n/a"
          deep="unknown"
          determinism="unknown"
          reuse_stage3="unknown"
          reuse_stage3_hit="n/a"
          reuse_stage2="unknown"
          reuse_stage2_hit="n/a"
          reuse_only="unknown"
          compiler_smoke="unknown"
          compiler_main_smoke="unknown"
          import_smoke="unknown"
          selfhost_eq="unknown"
          safe_mode="unknown"
          strict_local="unknown"
          cold_start_guard="unknown"
          module_preflight="unknown"
          module_preflight_entry="n/a"
          module_preflight_json="n/a"
          module_preflight_s="n/a"
          module_preflight_rss="n/a"
          module_preflight_ok="n/a"
          module_preflight_errors="n/a"
          module_preflight_warnings="n/a"
          module_preflight_first_diag="n/a"
          heavy_timeout="n/a"
          heavy_timeout_smoke="n/a"
          heavy_vmem="n/a"
          heavy_procs="n/a"
          gate2_stage3_rss="n/a"
          gate2_stage4_rss="n/a"
          gate2_stage4_run_rss="n/a"
          import_variant_compile_s="n/a"
          import_variant_compile_rss="n/a"
          import_variant_run_s="n/a"
          import_variant_run_rss="n/a"
          stage1_import_variant_compile_s="n/a"
          stage1_import_variant_compile_rss="n/a"
          stage1_import_variant_run_s="n/a"
          stage1_import_variant_run_rss="n/a"
          compiler_main_stage3_compile_s="n/a"
          compiler_main_stage3_compile_rss="n/a"
          compiler_main_stage4_compile_s="n/a"
          compiler_main_stage4_compile_rss="n/a"
          compiler_main_stage4_run_s="n/a"
          compiler_main_stage4_run_rss="n/a"
          det_hash="n/a"
          det_hash_metrics="n/a"
          selfhost_hash="n/a"
          failure_count=0
          failure_lines=""
          first_failure=""
          has_sigsegv="no"
          resource_hint="none"

          classify_exit_reason() {
            local code="$1"
            case "$code" in
              124) echo "timeout" ;;
              137) echo "killed (SIGKILL, possible OOM/vmem cap)" ;;
              143) echo "terminated (SIGTERM, likely timeout watchdog)" ;;
              *)
                if (( code >= 128 )); then
                  echo "terminated by signal $((code - 128))"
                else
                  echo "command error"
                fi
                ;;
            esac
          }

          record_exit_code() {
            local scope="$1"
            local key="$2"
            local raw="$3"

            if [[ ! "$raw" =~ ^[0-9]+$ ]]; then
              return
            fi
            if (( raw == 0 )); then
              return
            fi

            local reason
            reason="$(classify_exit_reason "$raw")"
            if (( raw == 139 )); then
              has_sigsegv="yes"
            fi
            failure_count=$((failure_count + 1))
            failure_lines+="- ${scope}:${key} -> exit=${raw} (${reason})\n"

            if [ -z "$first_failure" ]; then
              first_failure="${scope}:${key} -> exit=${raw} (${reason})"
            fi
          }

          if [ -f "$metrics_file" ]; then
            while IFS='=' read -r key value || [ -n "$key" ]; do
              case "$key" in
                gate1_seconds) gate1="$value" ;;
                gate2_seconds) gate2="$value" ;;
                gate3_seconds) gate3="$value" ;;
                total_seconds) total="$value" ;;
                deep_enabled) deep="$value" ;;
                determinism_enabled) determinism="$value" ;;
                reuse_stage3_enabled) reuse_stage3="$value" ;;
                reuse_stage3_hit) reuse_stage3_hit="$value" ;;
                reuse_stage2_enabled) reuse_stage2="$value" ;;
                reuse_stage2_hit) reuse_stage2_hit="$value" ;;
                reuse_only_enabled) reuse_only="$value" ;;
                s1_compiler_smoke_enabled) compiler_smoke="$value" ;;
                compiler_main_smoke_enabled) compiler_main_smoke="$value" ;;
                import_smoke_enabled) import_smoke="$value" ;;
                selfhost_eq_enabled) selfhost_eq="$value" ;;
                safe_mode) safe_mode="$value" ;;
                strict_local_mode) strict_local="$value" ;;
                cold_start_guard) cold_start_guard="$value" ;;
                module_preflight_enabled) module_preflight="$value" ;;
                module_preflight_entry) module_preflight_entry="$value" ;;
                module_preflight_json) module_preflight_json="$value" ;;
                module_preflight_seconds) module_preflight_s="$value" ;;
                module_preflight_maxrss_kb) module_preflight_rss="$value" ;;
                module_preflight_ok) module_preflight_ok="$value" ;;
                module_preflight_errors) module_preflight_errors="$value" ;;
                module_preflight_warnings) module_preflight_warnings="$value" ;;
                module_preflight_first_diagnostic) module_preflight_first_diag="$value" ;;
                heavy_timeout_seconds) heavy_timeout="$value" ;;
                heavy_timeout_smoke_seconds) heavy_timeout_smoke="$value" ;;
                heavy_safe_max_vmem_kb) heavy_vmem="$value" ;;
                heavy_safe_max_procs) heavy_procs="$value" ;;
                gate2_stage3_compile_maxrss_kb) gate2_stage3_rss="$value" ;;
                gate2_stage4_compile_maxrss_kb) gate2_stage4_rss="$value" ;;
                gate2_stage4_run_maxrss_kb) gate2_stage4_run_rss="$value" ;;
                import_variant_compile_seconds) import_variant_compile_s="$value" ;;
                import_variant_compile_maxrss_kb) import_variant_compile_rss="$value" ;;
                import_variant_run_seconds) import_variant_run_s="$value" ;;
                import_variant_run_maxrss_kb) import_variant_run_rss="$value" ;;
                stage1_import_variant_compile_seconds) stage1_import_variant_compile_s="$value" ;;
                stage1_import_variant_compile_maxrss_kb) stage1_import_variant_compile_rss="$value" ;;
                stage1_import_variant_run_seconds) stage1_import_variant_run_s="$value" ;;
                stage1_import_variant_run_maxrss_kb) stage1_import_variant_run_rss="$value" ;;
                compiler_main_smoke_stage3_compile_seconds) compiler_main_stage3_compile_s="$value" ;;
                compiler_main_smoke_stage3_compile_maxrss_kb) compiler_main_stage3_compile_rss="$value" ;;
                compiler_main_smoke_stage4_compile_seconds) compiler_main_stage4_compile_s="$value" ;;
                compiler_main_smoke_stage4_compile_maxrss_kb) compiler_main_stage4_compile_rss="$value" ;;
                compiler_main_smoke_stage4_run_seconds) compiler_main_stage4_run_s="$value" ;;
                compiler_main_smoke_stage4_run_maxrss_kb) compiler_main_stage4_run_rss="$value" ;;
                selfhost_eq_sha256) selfhost_hash="$value" ;;
                determinism_sha256) det_hash_metrics="$value" ;;
              esac

              if [[ "$key" == *_exit_code ]]; then
                record_exit_code "heavy" "$key" "$value"
              fi
            done < "$metrics_file"
          fi

          if [ ! -f "$gate1_resource_file" ] && [ -f "$fallback_gate1_resource_file" ]; then
            gate1_resource_file="$fallback_gate1_resource_file"
          fi

          if [ -f "$gate1_resource_file" ]; then
            while IFS='=' read -r key value || [ -n "$key" ]; do
              case "$key" in
                module_preflight) if [ "$module_preflight" = "unknown" ]; then module_preflight="$value"; fi ;;
                module_preflight_entry) if [ "$module_preflight_entry" = "n/a" ]; then module_preflight_entry="$value"; fi ;;
                module_preflight_json) if [ "$module_preflight_json" = "n/a" ]; then module_preflight_json="$value"; fi ;;
                module_preflight_check_seconds) if [ "$module_preflight_s" = "n/a" ]; then module_preflight_s="$value"; fi ;;
                module_preflight_check_maxrss_kb) if [ "$module_preflight_rss" = "n/a" ]; then module_preflight_rss="$value"; fi ;;
                module_preflight_ok) if [ "$module_preflight_ok" = "n/a" ]; then module_preflight_ok="$value"; fi ;;
                module_preflight_errors) if [ "$module_preflight_errors" = "n/a" ]; then module_preflight_errors="$value"; fi ;;
                module_preflight_warnings) if [ "$module_preflight_warnings" = "n/a" ]; then module_preflight_warnings="$value"; fi ;;
                module_preflight_first_diagnostic) if [ "$module_preflight_first_diag" = "n/a" ]; then module_preflight_first_diag="$value"; fi ;;
              esac

              if [[ "$key" == *_exit_code ]]; then
                record_exit_code "gate1" "$key" "$value"
              fi
            done < "$gate1_resource_file"
          fi

          if [ -s "$det_file" ]; then
            det_hash=$(awk '{print $1}' "$det_file")
          elif [ -n "$det_hash_metrics" ] && [ "$det_hash_metrics" != "n/a" ]; then
            det_hash="$det_hash_metrics"
          fi

          if [ -s "$selfhost_file" ]; then
            selfhost_hash=$(awk '{print $1}' "$selfhost_file")
          fi

          if [ "$module_preflight" != "enabled" ]; then
            module_preflight_json="n/a"
          fi

          if [ -z "$first_failure" ]; then
            first_failure="none"
          fi

          if [ "$has_sigsegv" = "yes" ]; then
            if [[ "$heavy_vmem" =~ ^[0-9]+$ ]] && [ "$heavy_vmem" != "0" ]; then
              if [ "$heavy_vmem" -lt 16777216 ]; then
                resource_hint="SIGSEGV observed under vmem cap ${heavy_vmem} KB; try KX_HEAVY_SAFE_MAX_VMEM_KB=16777216 (16 GiB) for local runs or 0 in CI."
              else
                resource_hint="SIGSEGV observed with vmem cap ${heavy_vmem} KB; inspect compiler_main smoke artifacts/logs for non-memory faults."
              fi
            else
              resource_hint="SIGSEGV observed; inspect compiler_main smoke artifacts/logs for likely runtime faults."
            fi
          fi

          {
            echo "### Bootstrap Heavy Summary"
            echo ""
            echo "- deep mode: ${deep}"
            echo "- determinism mode: ${determinism}"
            echo "- reuse stage3: ${reuse_stage3} (hit=${reuse_stage3_hit})"
            echo "- reuse stage2: ${reuse_stage2} (hit=${reuse_stage2_hit})"
            echo "- reuse-only mode: ${reuse_only}"
            echo "- stage1 compiler module smoke: ${compiler_smoke}"
            echo "- compiler_main two-hop smoke: ${compiler_main_smoke}"
            echo "- import namespace smoke: ${import_smoke}"
            echo "- self-host convergence mode: ${selfhost_eq}"
            echo "- safe mode: ${safe_mode}"
            echo "- strict local mode: ${strict_local}"
            echo "- cold-start guard: ${cold_start_guard}"
            echo "- module preflight: ${module_preflight} (${module_preflight_entry})"
            echo "- module preflight json: ${module_preflight_json}"
            echo "- module preflight artifact hint: bootstrap-heavy-artifacts -> ${module_preflight_json}"
            echo "- module preflight runtime: ${module_preflight_s}s (max RSS ${module_preflight_rss} KB)"
            echo "- module preflight diagnostics: ok=${module_preflight_ok}, errors=${module_preflight_errors}, warnings=${module_preflight_warnings}"
            echo "- module preflight first diagnostic: ${module_preflight_first_diag}"
            echo "- timeout (compile/smoke): ${heavy_timeout}s / ${heavy_timeout_smoke}s"
            echo "- safety caps (vmem/procs): ${heavy_vmem} KB / ${heavy_procs}"
            echo "- gate1 (S1_CORE smokes): ${gate1}s"
            echo "- gate2 (compiler_main two-hop): ${gate2}s"
            echo "- gate2 max RSS (stage3/stage4/run): ${gate2_stage3_rss} KB / ${gate2_stage4_rss} KB / ${gate2_stage4_run_rss} KB"
            echo "- import variant smoke (examples compile/run): ${import_variant_compile_s}s / ${import_variant_run_s}s"
            echo "- import variant smoke RSS (examples compile/run): ${import_variant_compile_rss} KB / ${import_variant_run_rss} KB"
            echo "- import variant smoke (stage1 compile/run): ${stage1_import_variant_compile_s}s / ${stage1_import_variant_run_s}s"
            echo "- import variant smoke RSS (stage1 compile/run): ${stage1_import_variant_compile_rss} KB / ${stage1_import_variant_run_rss} KB"
            echo "- compiler_main smoke (stage3/stage4/run): ${compiler_main_stage3_compile_s}s / ${compiler_main_stage4_compile_s}s / ${compiler_main_stage4_run_s}s"
            echo "- compiler_main smoke RSS (stage3/stage4/run): ${compiler_main_stage3_compile_rss} KB / ${compiler_main_stage4_compile_rss} KB / ${compiler_main_stage4_run_rss} KB"
            echo "- gate3 (self-host + determinism): ${gate3}s"
            echo "- total: ${total}s"
            echo "- failure signals observed: ${failure_count}"
            echo "- first non-zero step: ${first_failure}"
            echo "- resource hint: ${resource_hint}"
            echo "- self-host convergence sha256: ${selfhost_hash}"
            echo "- determinism sha256: ${det_hash}"

            if [ "$failure_count" -gt 0 ]; then
              echo ""
              echo "#### Failure Classification"
              printf '%b' "$failure_lines"
            fi

            if [ "$resource_hint" != "none" ]; then
              echo ""
              echo "#### Resource Hint"
              echo "- ${resource_hint}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
