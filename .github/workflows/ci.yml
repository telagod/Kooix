name: ci

on:
  push:
    branches:
      - main
  pull_request: {}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM tools (llc) + clang
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm clang jq

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Format
        run: cargo fmt --all --check

      - name: Test
        # Keep resource usage stable: bootstrap/native tests may spawn external toolchains.
        env:
          KX_DETERMINISM: "1"
          KX_GOLDEN: "1"
        run: cargo test -p kooixc -j 2 -- --test-threads=1

      - name: Module-aware check gate (JSON)
        run: cargo run -p kooixc -- check-modules examples/import_alias_main.kooix --json > module-check.json

      - name: Module-aware check gate (strict warnings)
        run: cargo run -p kooixc -- check-modules examples/import_alias_main.kooix --json --strict-warnings > module-check-strict.json

      - name: Upload module-check artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: module-check-json
          path: |
            module-check.json
            module-check-strict.json
          if-no-files-found: warn

      - name: Module-check summary
        if: always()
        run: |
          if [ ! -f module-check.json ]; then
            {
              echo "### Module Check Summary"
              echo ""
              echo "- artifact: missing (module-check.json not generated)"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          error_count=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "error")] | length' module-check.json)
          warning_count=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "warning")] | length' module-check.json)
          first_diagnostic=$(jq -r '([.modules[]?.diagnostics[]?][0].message // "none")' module-check.json)

          {
            echo "### Module Check Summary"
            echo ""
            echo "- errors: ${error_count}"
            echo "- warnings: ${warning_count}"
            echo "- first diagnostic: ${first_diagnostic}"
          } >> "$GITHUB_STEP_SUMMARY"
