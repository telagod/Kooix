name: ci

on:
  push:
    branches:
      - main
  pull_request: {}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM tools (llc) + clang
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm clang jq

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Format
        run: cargo fmt --all --check

      - name: Bootstrap cold-start guard smoke
        run: |
          set -euo pipefail

          out_v013="$(mktemp /tmp/kx-guard-v013-log-XXXXXX)"
          out_heavy="$(mktemp /tmp/kx-guard-heavy-log-XXXXXX)"
          dir_v013="$(mktemp -d /tmp/kx-guard-v013-dist-XXXXXX)"
          dir_heavy="$(mktemp -d /tmp/kx-guard-heavy-dist-XXXXXX)"
          trap 'rm -f "$out_v013" "$out_heavy"; rm -rf "$dir_v013" "$dir_heavy"' EXIT

          if KX_SAFE_COLD_START_GUARD=1 CARGO_BUILD_JOBS=1 ./scripts/bootstrap_v0_13.sh "$dir_v013" >"$out_v013" 2>&1; then
            echo "expected bootstrap_v0_13 cold-start guard to fail fast" >&2
            cat "$out_v013" >&2
            exit 1
          fi
          grep -q "cold-start rebuild blocked" "$out_v013"

          if KX_HEAVY_COLD_START_GUARD=1 CARGO_BUILD_JOBS=1 ./scripts/bootstrap_heavy_gate.sh "$dir_heavy" >"$out_heavy" 2>&1; then
            echo "expected bootstrap_heavy cold-start guard to fail fast" >&2
            cat "$out_heavy" >&2
            exit 1
          fi
          grep -q "cold-start rebuild blocked" "$out_heavy"

          echo "ok: bootstrap cold-start guard smoke passed"

      - name: Test
        # Keep resource usage stable: bootstrap/native tests may spawn external toolchains.
        env:
          KX_DETERMINISM: "1"
          KX_GOLDEN: "1"
        run: cargo test -p kooixc -j 2 -- --test-threads=1

      - name: Module-aware check gate matrix
        run: |
          set -euo pipefail

          cargo run -p kooixc -- check-modules examples/import_alias_main.kooix --json > module-check-pass.json

          cargo run -p kooixc -- check-modules examples/module_check_gate_warn.kooix --json > module-check-warn.json
          if cargo run -p kooixc -- check-modules examples/module_check_gate_warn.kooix --json --strict-warnings > module-check-warn-strict.json; then
            echo "expected strict warning gate to fail" >&2
            exit 1
          fi

          if cargo run -p kooixc -- check-modules examples/module_check_gate_error.kooix --json > module-check-error.json; then
            echo "expected error gate to fail" >&2
            exit 1
          fi

          if cargo run -p kooixc -- check-modules examples/module_check_gate_error.kooix --json --strict-warnings > module-check-error-strict.json; then
            echo "expected strict error gate to fail" >&2
            exit 1
          fi

      - name: Module-preflight metrics script smoke
        run: |
          set -euo pipefail

          cat > /tmp/module-preflight-enabled.metrics <<'EOF'
          module_preflight_enabled=enabled
          module_preflight_entry=examples/import_variant_main.kooix
          module_preflight_json=module-check-pass.json
          module_preflight_ok=true
          module_preflight_errors=0
          module_preflight_warnings=0
          module_preflight_first_diagnostic=none
          EOF
          ./scripts/bootstrap_module_preflight_json_check.sh /tmp/module-preflight-enabled.metrics --assert

          cat > /tmp/module-preflight-disabled.metrics <<'EOF'
          module_preflight_enabled=disabled
          module_preflight_entry=examples/import_variant_main.kooix
          module_preflight_json=n/a
          module_preflight_ok=skipped
          module_preflight_errors=n/a
          module_preflight_warnings=n/a
          module_preflight_first_diagnostic=none
          EOF
          ./scripts/bootstrap_module_preflight_json_check.sh /tmp/module-preflight-disabled.metrics --assert

      - name: Upload module-check artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: module-check-json
          path: |
            module-check-pass.json
            module-check-warn.json
            module-check-warn-strict.json
            module-check-error.json
            module-check-error-strict.json
          if-no-files-found: warn

      - name: Module-check summary
        if: always()
        run: |
          if [ ! -f module-check-pass.json ]; then
            {
              echo "### Module Check Summary"
              echo ""
              echo "- artifact: missing (module-check-*.json not generated)"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          pass_ok=$(jq -r '.ok' module-check-pass.json)
          warn_ok=$(jq -r '.ok' module-check-warn.json)
          warn_strict_ok=$(jq -r '.ok' module-check-warn-strict.json)
          error_ok=$(jq -r '.ok' module-check-error.json)
          error_strict_ok=$(jq -r '.ok' module-check-error-strict.json)

          pass_errors=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "error")] | length' module-check-pass.json)
          pass_warnings=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "warning")] | length' module-check-pass.json)

          warn_errors=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "error")] | length' module-check-warn.json)
          warn_warnings=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "warning")] | length' module-check-warn.json)
          warn_first=$(jq -r '([.modules[]?.diagnostics[]?][0].message // "none")' module-check-warn.json)

          error_errors=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "error")] | length' module-check-error.json)
          error_warnings=$(jq '[.modules[]?.diagnostics[]? | select(.severity == "warning")] | length' module-check-error.json)
          error_first=$(jq -r '([.modules[]?.diagnostics[]?][0].message // "none")' module-check-error.json)

          {
            echo "### Module Check Summary"
            echo ""
            echo "- pass-case ok: ${pass_ok} (errors=${pass_errors}, warnings=${pass_warnings})"
            echo "- warn-case ok: ${warn_ok} (errors=${warn_errors}, warnings=${warn_warnings})"
            echo "- warn-case strict ok: ${warn_strict_ok}"
            echo "- error-case ok: ${error_ok} (errors=${error_errors}, warnings=${error_warnings})"
            echo "- error-case strict ok: ${error_strict_ok}"
            echo "- warn-case first diagnostic: ${warn_first}"
            echo "- error-case first diagnostic: ${error_first}"
          } >> "$GITHUB_STEP_SUMMARY"
