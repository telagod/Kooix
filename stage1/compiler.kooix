import "../stdlib/prelude";
import "diag";
import "token";
import "lexer";
import "parser";
import "resolver";
import "typecheck";

fn s1_compile(source: Text) -> Result<Int, S1Diagnostic>
intent "Stage1 compiler (pure): source -> (future) diagnostics + artifacts"
evidence {
  trace "stage1.compile.v0";
  metrics [stage1_compile_calls];
}
{
  let tokens: Result<List<S1Token>, S1Diagnostic> = s1_lex(source);
  match tokens {
    Ok(ts) => {
      let ast: Result<S1Program, S1Diagnostic> = s1_parse(ts);
      match ast {
        Ok(p) => {
          let resolved: Result<S1Program, S1Diagnostic> = s1_resolve_program(p);
          match resolved {
            Ok(p2) => {
              let checked: Result<S1Program, S1Diagnostic> = s1_typecheck_program(p2);
              match checked {
                Ok(_p3) => Ok(0);
                Err(e4) => Err(e4);
              }
            };
            Err(e3) => Err(e3);
          }
        };
        Err(e2) => Err(e2);
      }
    };
    Err(e) => Err(e);
  }
};
