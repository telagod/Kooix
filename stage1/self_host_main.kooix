import "../stdlib/prelude";
import "diag";
import "llvm_emit";
import "source_map";

fn main() -> Int
intent "Stage1 self-host bootstrap (v0): emit stage2 LLVM IR (minimal subset) and write to disk"
evidence {
  trace "stage1.self_host.v0";
  metrics [stage1_self_host_calls];
}
{
  let src_r: Result<Text, Text> = s1_load_source_map("stage1/stage2_min.kooix");
  match src_r {
    Err(m) => {
      host_eprintln(m);
      2
    };
    Ok(src) => {
      let ir_r: Result<Text, S1Diagnostic> = s1_emit_llvm_ir(src);
      match ir_r {
        Err(e) => {
          host_eprintln(e.message);
          3
        };
        Ok(ir) => {
          let w: Result<Int, Text> = fs_write_text("/tmp/kooixc_stage2.ll", ir);
          match w {
            Ok(_n) => 0;
            Err(msg) => {
              host_eprintln(msg);
              4
            };
          }
        };
      }
    };
  }
};
